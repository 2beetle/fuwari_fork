---
import type { CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";

interface Props {
  class?: string;
  summary?: string;
  generatedDate?: Date;
  modelName?: string;
  entry?: CollectionEntry<"posts">;
}

const {
  class: className,
  summary,
  generatedDate,
  modelName,
  entry
} = Astro.props;

// 如果没有直接的summary，尝试从entry.data获取
const finalSummary = summary || entry?.data.aiSummary;
const finalGeneratedDate = generatedDate || entry?.data.aiSummaryGenerated;
const finalModelName = modelName || entry?.data.aiSummaryModel;

// 只有当有AI总结时才显示组件
const shouldShow = finalSummary && finalSummary.trim().length > 0;

// 格式化生成日期
const formatDate = (date: Date) => {
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
};
---

{shouldShow && (
  <div class:list={["ai-summary-container card-base rounded-xl p-6 mb-6 transition-all duration-300 onload-animation", className]}>
    <!-- 标题栏 -->
    <div class="flex items-center justify-between mb-4 cursor-pointer" id="ai-summary-header">
      <div class="flex items-center gap-2">
        <div class="ai-icon-container">
          <Icon name="material-symbols:auto-awesome-rounded" class="text-[var(--primary)] text-xl"></Icon>
        </div>
        <h3 class="text-lg font-semibold text-[var(--title-color)]">
          {i18n(I18nKey.aiSummary)}
        </h3>
      </div>
      <div class="flex items-center gap-3">
        {finalGeneratedDate && (
          <span class="text-xs text-[var(--meta-color)] opacity-75 hidden sm:inline">
            {formatDate(finalGeneratedDate)}
          </span>
        )}
        <div id="ai-summary-toggle" class="transition-transform duration-300">
          <Icon name="material-symbols:expand-more-rounded" class="text-[var(--meta-color)] text-xl"></Icon>
        </div>
      </div>
    </div>

    <!-- 总结内容 -->
    <div id="ai-summary-content" class="ai-summary-content">
      <div class="text-[var(--text-color)] leading-relaxed prose prose-sm max-w-none">
        <!-- 先直接显示内容，确保数据传递正常 -->
        <p id="ai-summary-text-static" class="m-0">{finalSummary}</p>
        <p id="ai-summary-text-dynamic" class="m-0" style="display: none;"></p>
      </div>

      {(finalModelName || finalGeneratedDate) && (
        <div class="mt-3 pt-3 border-t border-[var(--line-divider)] border-dashed">
          <div class="flex items-center justify-between text-xs text-[var(--meta-color)] opacity-60">
            {finalModelName && (
              <span>{i18n(I18nKey.aiModel)}: {finalModelName}</span>
            )}
            {finalGeneratedDate && (
              <span class="sm:hidden">{formatDate(finalGeneratedDate)}</span>
            )}
          </div>
        </div>
      )}
    </div>
  </div>
)}

<!-- 暂时移除JavaScript，确保内容正确显示 -->

<style>
  .ai-summary-container {
    border: 1px solid var(--line-divider);
    background: var(--card-bg);
    position: relative;
    overflow: hidden;
  }

  .ai-summary-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    opacity: 0.8;
  }

  .ai-icon-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 0.5rem;
    background: linear-gradient(135deg, var(--primary-light), var(--primary));
    opacity: 0.9;
  }

  .ai-summary-content {
    max-height: none;
    opacity: 1;
    overflow: visible;
    transition: max-height 0.5s ease-out, opacity 0.3s ease-out;
  }

  .ai-summary-container:hover {
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.1);
  }

  .dark .ai-summary-container:hover {
    box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.2);
  }

  /* 标题栏hover效果 */
  .ai-summary-container > div:first-child:hover {
    background: rgba(var(--primary-rgb), 0.05);
    margin: -1rem -1rem 1rem -1rem;
    padding: 1rem;
    border-radius: 0.75rem 0.75rem 0 0;
  }

  /* 打字机光标效果 */
  #ai-summary-text {
    display: inline;
  }

  #ai-summary-text::after {
    content: '|';
    animation: blink 1s infinite;
    color: var(--primary);
    font-weight: bold;
  }

  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  /* 移动端优化 */
  @media (max-width: 640px) {
    .ai-summary-container {
      margin: 0 -1rem 1rem -1rem;
      border-radius: 0;
      border-left: none;
      border-right: none;
    }

    .ai-summary-container > div:first-child:hover {
      margin: -1.5rem -1.5rem 1rem -1.5rem;
      padding: 1.5rem;
    }
  }

  /* 确保CSS变量存在 */
  :root {
    --primary-rgb: 59, 130, 246;
    --primary-light: rgba(59, 130, 246, 0.1);
    --title-color: oklch(0.15 0.02 264.38);
    --text-color: oklch(0.25 0.02 264.38);
    --meta-color: oklch(0.55 0.02 264.38);
    --line-divider: oklch(0.85 0.01 264.38);
    --accent: oklch(0.65 0.2 15);
  }

  .dark {
    --primary-rgb: 96, 165, 250;
    --primary-light: rgba(96, 165, 250, 0.15);
    --title-color: oklch(0.9 0.02 264.38);
    --text-color: oklch(0.8 0.02 264.38);
    --meta-color: oklch(0.65 0.02 264.38);
    --line-divider: oklch(0.3 0.01 264.38);
    --accent: oklch(0.7 0.2 15);
  }
</style>