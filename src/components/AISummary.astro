---
import type { CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";

interface Props {
  class?: string;
  summary?: string;
  generatedDate?: Date;
  modelName?: string;
  entry?: CollectionEntry<"posts">;
}

const {
  class: className,
  summary,
  generatedDate,
  modelName,
  entry
} = Astro.props;

// 如果没有直接的summary，尝试从entry.data获取
const finalSummary = summary || entry?.data.aiSummary;
const finalGeneratedDate = generatedDate || entry?.data.aiSummaryGenerated;
const finalModelName = modelName || entry?.data.aiSummaryModel;

// 只有当有AI总结时才显示组件
const shouldShow = finalSummary && finalSummary.trim().length > 0;

// 格式化生成日期
const formatDate = (date: Date) => {
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
};
---

{shouldShow && (
  <div class:list={["ai-summary-container card-base rounded-xl p-6 mb-6 transition-all duration-300 onload-animation", className]}>
    <!-- 标题栏 -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="ai-icon-container">
          <Icon name="material-symbols:auto-awesome-rounded" class="text-white text-lg"></Icon>
        </div>
        <h3 class="text-lg font-bold text-[var(--ai-summary-title)]">
          {i18n(I18nKey.aiSummary)}
        </h3>
      </div>
      <div class="flex items-center gap-3">
        {finalGeneratedDate && (
          <span class="text-sm text-[var(--ai-summary-date)] bg-[var(--ai-summary-date-bg)] px-2 py-1 rounded-full">
            {formatDate(finalGeneratedDate)}
          </span>
        )}
      </div>
    </div>

    <!-- 总结内容 -->
    <div class="ai-summary-content">
      <div class="bg-[var(--ai-summary-content-bg)] rounded-lg p-4 border border-[var(--ai-summary-content-border)]">
        <p class="m-0 text-[var(--ai-summary-text)] leading-relaxed">
          {finalSummary}
        </p>
      </div>

      {(finalModelName || finalGeneratedDate) && (
        <div class="mt-4 pt-4 border-t border-[var(--ai-summary-meta-border)]">
          <div class="flex items-center justify-between text-xs">
            {finalModelName && (
              <span class="text-[var(--ai-summary-meta)] bg-[var(--ai-summary-meta-bg)] px-2 py-1 rounded">
                <Icon name="material-symbols:psychology-alt" class="inline mr-1 text-xs"></Icon>
                {i18n(I18nKey.aiModel)}: {finalModelName}
              </span>
            )}
            {finalGeneratedDate && (
              <span class="text-[var(--ai-summary-meta)] sm:hidden">
                <Icon name="material-symbols:schedule" class="inline mr-1 text-xs"></Icon>
                {formatDate(finalGeneratedDate)}
              </span>
            )}
          </div>
        </div>
      )}
    </div>
  </div>
)}

<!-- 暂时移除JavaScript，确保内容正确显示 -->

<style>
  .ai-summary-container {
    border: 1px solid var(--ai-summary-border);
    background: var(--ai-summary-bg);
    position: relative;
    overflow: hidden;
    width: 100%;
  }

  .ai-summary-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--ai-summary-gradient-start), var(--ai-summary-gradient-end));
    opacity: 0.9;
  }

  .ai-icon-container {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 0.75rem;
    background: linear-gradient(135deg, var(--ai-summary-icon-start), var(--ai-summary-icon-end));
    box-shadow: 0 4px 12px rgba(var(--ai-summary-icon-shadow), 0.3);
  }

  .ai-summary-content {
    max-height: none;
    opacity: 1;
    overflow: visible;
    transition: max-height 0.5s ease-out, opacity 0.3s ease-out;
  }

  /* 移动端优化 */
  @media (max-width: 640px) {
    .ai-summary-container {
      margin: 0 -1rem 1rem -1rem;
      border-radius: 0;
      border-left: none;
      border-right: none;
    }
  }

  /* AI总结专用CSS变量 */
  :root {
    --primary-rgb: 59, 130, 246;
    --primary-light: rgba(59, 130, 246, 0.1);
    --title-color: oklch(0.15 0.02 264.38);
    --text-color: oklch(0.25 0.02 264.38);
    --meta-color: oklch(0.55 0.02 264.38);
    --line-divider: oklch(0.85 0.01 264.38);
    --accent: oklch(0.65 0.2 15);

    /* AI总结主题变量 - 亮色主题 */
    --ai-summary-bg: oklch(0.98 0.005 264.38);
    --ai-summary-border: oklch(0.88 0.02 264.38);
    --ai-summary-gradient-start: oklch(0.62 0.18 15);
    --ai-summary-gradient-end: oklch(0.58 0.22 250);
    --ai-summary-title: oklch(0.15 0.02 264.38);
    --ai-summary-text: oklch(0.22 0.015 264.38);
    --ai-summary-date: oklch(0.6 0.08 250);
    --ai-summary-date-bg: oklch(0.94 0.03 250);
    --ai-summary-content-bg: oklch(1 0.008 264.38);
    --ai-summary-content-border: oklch(0.9 0.02 264.38);
    --ai-summary-meta: oklch(0.45 0.02 264.38);
    --ai-summary-meta-border: oklch(0.85 0.01 264.38);
    --ai-summary-meta-bg: oklch(0.92 0.02 264.38);
    --ai-summary-icon-start: oklch(0.58 0.18 15);
    --ai-summary-icon-end: oklch(0.54 0.22 250);
    --ai-summary-icon-shadow: 59, 130, 246;
  }

  .dark {
    --primary-rgb: 96, 165, 250;
    --primary-light: rgba(96, 165, 250, 0.15);
    --title-color: oklch(0.9 0.02 264.38);
    --text-color: oklch(0.8 0.02 264.38);
    --meta-color: oklch(0.65 0.02 264.38);
    --line-divider: oklch(0.3 0.01 264.38);
    --accent: oklch(0.7 0.2 15);

    /* AI总结主题变量 - 暗色主题 */
    --ai-summary-bg: oklch(0.12 0.01 264.38);
    --ai-summary-border: oklch(0.25 0.02 264.38);
    --ai-summary-gradient-start: oklch(0.65 0.18 15);
    --ai-summary-gradient-end: oklch(0.61 0.22 250);
    --ai-summary-title: oklch(0.95 0.02 264.38);
    --ai-summary-text: oklch(0.85 0.015 264.38);
    --ai-summary-date: oklch(0.7 0.12 250);
    --ai-summary-date-bg: oklch(0.15 0.04 250);
    --ai-summary-content-bg: oklch(0.08 0.008 264.38);
    --ai-summary-content-border: oklch(0.2 0.02 264.38);
    --ai-summary-meta: oklch(0.6 0.02 264.38);
    --ai-summary-meta-border: oklch(0.25 0.01 264.38);
    --ai-summary-meta-bg: oklch(0.18 0.02 264.38);
    --ai-summary-icon-start: oklch(0.61 0.18 15);
    --ai-summary-icon-end: oklch(0.57 0.22 250);
    --ai-summary-icon-shadow: 96, 165, 250;
  }
</style>